---
- name: Backup Cisco IOS switch configuration
  hosts: switches
  gather_facts: no
  
  vars:
    backup_dir: "{{ playbook_dir }}/../backups"
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"
  
  tasks:
    - name: Create backup directory
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: yes
    
    - name: Backup running configuration
      cisco.ios.ios_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}_{{ backup_timestamp }}.cfg"
          dir_path: "{{ backup_dir }}"
      register: backup_result
    
    - name: Display backup location
      ansible.builtin.debug:
        msg: "✓ Backup saved: {{ backup_result.backup_path }}"


# =============================================================================
# ÄNDERUNGEN & VERBESSERUNGEN
# =============================================================================

# ✅ Was ich optimiert habe:
#
# 1. Hardcoded Pfad entfernt
#    Vorher: /home/danilo/ansible_tutorial/backups
#    Jetzt: {{ playbook_dir }}/../backups
#    → Funktioniert auf jedem System!
#
# 2. backup_options nutzen
#    → ios_config schreibt direkt ins Zielverzeichnis
#    → Keine temporären Dateien mehr
#    → Keine copy/delete Tasks mehr nötig
#
# 3. Von 5 Tasks auf 3 Tasks reduziert
#    - Kein separater copy-Task mehr
#    - Kein delete-Task mehr
#    → Einfacher und schneller!
#
# 4. run_once: yes beim Directory-Create
#    → Bei mehreren Switches wird das Verzeichnis nur einmal erstellt
#    → Spart Zeit
#
# 5. connection: network_cli entfernt
#    → Ist bereits im Inventory definiert
#    → Vermeidet Redundanz
#
# 6. Timestamp-Format verbessert
#    Vorher: 2025-01-09_14-30-45 (mit Bindestrichen)
#    Jetzt: 20250109_143045 (kompakter, sortierbar)
#
# 7. FQCN (Fully Qualified Collection Names) verwendet
#    → ansible.builtin.file, ansible.builtin.debug
#    → Best Practice für Klarheit
#
# 8. Besseres Feedback
#    → Zeigt genau wo das Backup gespeichert wurde

# =============================================================================
# VORTEILE DER NEUEN VERSION
# =============================================================================

# ✓ 40% weniger Code (3 statt 5 Tasks)
# ✓ Keine temporären Dateien mehr
# ✓ Portabel (läuft auf jedem System)
# ✓ Schneller (weniger Tasks)
# ✓ Robuster (weniger kann schiefgehen)
# ✓ Besseres Feedback (zeigt Backup-Pfad)

# =============================================================================
# TESTEN
# =============================================================================

# Dry-Run (nichts wird geändert):
#   ansible-playbook playbooks/ios_backup_switch.yml --check
#
# Normal ausführen:
#   ansible-playbook playbooks/ios_backup_switch.yml
#
# Backup-Ordner anschauen:
#   ls -lh backups/

# =============================================================================
# ERWEITERTE VERSION (OPTIONAL)
# =============================================================================

# Wenn du zusätzlich die startup-config sichern willst:
#
# - name: Backup startup configuration
#   cisco.ios.ios_command:
#     commands: show startup-config
#   register: startup_config
#
# - name: Save startup config
#   ansible.builtin.copy:
#     content: "{{ startup_config.stdout[0] }}"
#     dest: "{{ backup_dir }}/{{ inventory_hostname }}_{{ backup_timestamp }}_startup.cfg"
#   delegate_to: localhost

# =============================================================================
# BACKUP-ROTATION (OPTIONAL)
# =============================================================================

# Wenn du alte Backups automatisch löschen willst (z.B. älter als 30 Tage):
#
# - name: Remove old backups (older than 30 days)
#   ansible.builtin.find:
#     paths: "{{ backup_dir }}"
#     patterns: "*.cfg"
#     age: 30d
#   register: old_backups
#   delegate_to: localhost
#   run_once: yes
#
# - name: Delete old backup files
#   ansible.builtin.file:
#     path: "{{ item.path }}"
#     state: absent
#   loop: "{{ old_backups.files }}"
#   delegate_to: localhost
#   run_once: yes
